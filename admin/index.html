<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂêéÂè∞ÁÆ°ÁêÜ - ÂØºËà™Á´ô</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #ffffff;
            min-height: 100vh;
        }

        .header {
            background: #ffffff;
            color: #333;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .header h1 {
            font-size: 1.5em;
            color: #333;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            font-weight: 600;
            border: 2px solid #007bff;
        }

        .btn-primary:hover {
            background: #0056b3;
            border-color: #0056b3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #007bff;
            color: white;
            font-weight: 600;
        }

        .btn-success:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            font-weight: 600;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: transparent;
            color: #333;
        }

        .stat-info h3 {
            font-size: 2em;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-info p {
            color: #666;
            font-size: 0.9em;
        }

        .content-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section-header {
            padding: 20px 25px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 1.3em;
            color: #333;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f9fafb;
        }

        th {
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            color: #666;
            font-size: 0.9em;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
        }

        tbody tr {
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        .site-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .site-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: transparent;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .site-details h4 {
            font-size: 0.95em;
            color: #333;
            margin-bottom: 3px;
        }

        .site-details p {
            font-size: 0.85em;
            color: #999;
        }

        .category-tag {
            display: inline-block;
            padding: 5px 12px;
            background: #e0e7ff;
            color: #007bff;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 0.85em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            margin-bottom: 25px;
        }

        .modal-header h3 {
            font-size: 1.5em;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.3s ease;
            outline: none;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
            display: none;
        }

        .alert-error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .alert-success {
            background: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }

        @media (max-width: 768px) {
            .stats {
                grid-template-columns: 1fr;
            }

            .table-container {
                font-size: 0.9em;
            }

            th, td {
                padding: 12px 15px;
            }

            .actions {
                flex-direction: column;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä ÂØºËà™Á´ôÂêéÂè∞ÁÆ°ÁêÜ</h1>
        <div class="header-actions">
            <a href="/daohang/index.html" class="btn btn-primary">Êü•ÁúãÂâçÂè∞</a>
            <button class="btn btn-danger" onclick="logout()">ÈÄÄÂá∫ÁôªÂΩï</button>
        </div>
    </div>

    <div class="container">
        <div id="alert" class="alert"></div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-icon">üìö</div>
                <div class="stat-info">
                    <h3 id="totalSites">0</h3>
                    <p>ÁΩëÁ´ôÊÄªÊï∞</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÇ</div>
                <div class="stat-info">
                    <h3 id="totalCategories">0</h3>
                    <p>ÂàÜÁ±ªÊï∞Èáè</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üëÄ</div>
                <div class="stat-info">
                    <h3 id="todayVisits">0</h3>
                    <p>‰ªäÊó•ËÆøÈóÆ</p>
                </div>
            </div>
        </div>

        <div class="content-section">
            <div class="section-header">
                <h2>ÁΩëÁ´ôÁÆ°ÁêÜ</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="openImportModal()">üì• ÂØºÂÖ•‰π¶Á≠æ</button>
                    <button class="btn btn-success" onclick="openAddModal()">+ Ê∑ªÂä†ÁΩëÁ´ô</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ÁΩëÁ´ô‰ø°ÊÅØ</th>
                            <th>ÂàÜÁ±ª</th>
                            <th>ÁΩëÂùÄ</th>
                            <th>ÊèèËø∞</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="sitesTable">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px;">
                                Âä†ËΩΩ‰∏≠...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="paginationContainer" style="padding: 20px; display: flex; justify-content: space-between; align-items: center; border-top: 2px solid #f0f0f0;">
                <div style="color: #666; font-size: 0.9em;">
                    ÂÖ± <strong id="totalCount" style="color: #007bff;">0</strong> Êù°ËÆ∞ÂΩï
                </div>
            </div>
        </div>
    </div>

    <!-- Ê∑ªÂä†/ÁºñËæëÁΩëÁ´ôÊ®°ÊÄÅÊ°Ü -->
    <div id="siteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Ê∑ªÂä†ÁΩëÁ´ô</h3>
            </div>
            <form id="siteForm">
                <input type="hidden" id="siteId" name="id">

                <div class="form-group">
                    <label for="siteName">ÁΩëÁ´ôÂêçÁß∞ *</label>
                    <input type="text" id="siteName" name="name" required>
                </div>

                <div class="form-group">
                    <label for="siteUrl">ÁΩëÁ´ôÁΩëÂùÄ *</label>
                    <input type="text" id="siteUrl" name="url" required placeholder="https://example.com" onblur="validateAndFetchMetadata()">
                    <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;">ËæìÂÖ•ÁΩëÂùÄÂêéËá™Âä®Ëé∑ÂèñÊ†áÈ¢òÂíåÂõæÊ†á(ÂøÖÈ°ª‰ª•http://Êàñhttps://ÂºÄÂ§¥)</small>
                </div>

                <div class="form-group">
                    <label for="siteIcon">ÁΩëÁ´ôÂõæÊ†á</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="siteIcon" name="icon" placeholder="üåê" style="flex: 1;">
                        <img id="iconPreview" src="" style="width: 40px; height: 40px; border-radius: 8px; display: none; border: 2px solid #e0e0e0;">
                    </div>
                    <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;">ÂèØ‰ª•ËæìÂÖ•emojiÊàñËá™Âä®Ëé∑ÂèñÁΩëÁ´ôÂõæÊ†á</small>
                </div>

                <div class="form-group">
                    <label for="siteCategory">ÂàÜÁ±ª *</label>
                    <select id="siteCategory" name="category" required>
                        <option value="">ÈÄâÊã©ÂàÜÁ±ª</option>
                        <option value="Âú®Á∫øÂ∑•ÂÖ∑">üìö Âú®Á∫øÂ∑•ÂÖ∑ & ÂÆûÁî®Êü•ËØ¢</option>
                        <option value="ÂÆâÂÖ®Â∑•ÂÖ∑">üõ°Ô∏è ÂÆâÂÖ®Â∑•ÂÖ∑ & ÊµãÁªòÂπ≥Âè∞</option>
                        <option value="ÂºÄÂèëËøêÁª¥">üíª ÂºÄÂèëËøêÁª¥ & ‰∏ªÊú∫ÊúçÂä°</option>
                        <option value="ÁΩëÁªúÂüüÂêç">üåê ÁΩëÁªú & ÂüüÂêçÂ∑•ÂÖ∑</option>
                        <option value="ÊäÄÊúØÊïôÁ®ã">üìö ÊäÄÊúØÊïôÁ®ã & Á§æÂå∫</option>
                        <option value="AIÂ∑•ÂÖ∑">ü§ñ AIÂ∑•ÂÖ∑ & ÂÖ∂‰ªñ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="siteDescription">ÁΩëÁ´ôÊèèËø∞ *</label>
                    <textarea id="siteDescription" name="description" required></textarea>
                </div>

                <div class="form-group">
                    <label for="siteKeywords">ÂÖ≥ÈîÆËØç (Áî®Á©∫Ê†ºÂàÜÈöî)</label>
                    <input type="text" id="siteKeywords" name="keywords" placeholder="Â∑•ÂÖ∑ Âú®Á∫ø Êü•ËØ¢">
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-success">‰øùÂ≠ò</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ÂØºÂÖ•‰π¶Á≠æÊ®°ÊÄÅÊ°Ü -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì• ÂØºÂÖ•‰π¶Á≠æÊñá‰ª∂</h3>
            </div>
            <form id="importForm">
                <div class="form-group">
                    <label for="bookmarkFile">ÈÄâÊã©‰π¶Á≠æÊñá‰ª∂ *</label>
                    <input type="file" id="bookmarkFile" name="bookmarkFile" accept=".html,.htm" required style="padding: 10px;">
                    <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;">
                        ÊîØÊåÅ Netscape ‰π¶Á≠æÊ†ºÂºè (Chrome„ÄÅFirefox„ÄÅEdge ÂØºÂá∫ÁöÑ‰π¶Á≠æÊñá‰ª∂)
                    </small>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="checkDuplicates" name="checkDuplicates" checked style="width: auto; cursor: pointer;">
                        <span>Ë∑≥ËøáÈáçÂ§çÁöÑÁΩëÂùÄ</span>
                    </label>
                    <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;">
                        ÂãæÈÄâÂêéÂ∞ÜËá™Âä®Ë∑≥ËøáÊï∞ÊçÆÂ∫ì‰∏≠Â∑≤Â≠òÂú®ÁöÑÁΩëÂùÄ
                    </small>
                </div>

                <div id="importProgress" style="display: none; margin: 20px 0;">
                    <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div id="progressBar" style="background: #007bff; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <p id="progressText" style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9em;"></p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeImportModal()">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-success" id="importBtn">ÂºÄÂßãÂØºÂÖ•</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
        function checkAuth() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                window.location.href = '/daohang/admin/login.html';
                return false;
            }
            return true;
        }

        // ÈÄÄÂá∫ÁôªÂΩï
        function logout() {
            if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêó?')) {
                localStorage.removeItem('admin_token');
                window.location.href = '/daohang/admin/login.html';
            }
        }

        // ÊòæÁ§∫ÊèêÁ§∫
        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        // ÊâìÂºÄÊ∑ªÂä†Ê®°ÊÄÅÊ°Ü
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Ê∑ªÂä†ÁΩëÁ´ô';
            document.getElementById('siteForm').reset();
            document.getElementById('siteId').value = '';
            document.getElementById('siteModal').classList.add('active');
        }

        // ÊâìÂºÄÁºñËæëÊ®°ÊÄÅÊ°Ü
        function openEditModal(site) {
            document.getElementById('modalTitle').textContent = 'ÁºñËæëÁΩëÁ´ô';
            document.getElementById('siteId').value = site.id;
            document.getElementById('siteName').value = site.name;
            document.getElementById('siteUrl').value = site.url;
            document.getElementById('siteIcon').value = site.icon || '';
            document.getElementById('siteCategory').value = site.category;
            document.getElementById('siteDescription').value = site.description;
            document.getElementById('siteKeywords').value = site.keywords || '';
            document.getElementById('siteModal').classList.add('active');
        }

        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        function closeModal() {
            document.getElementById('siteModal').classList.remove('active');
        }

        // ÊâìÂºÄÂØºÂÖ•Ê®°ÊÄÅÊ°Ü
        function openImportModal() {
            document.getElementById('importForm').reset();
            document.getElementById('importProgress').style.display = 'none';
            document.getElementById('importModal').classList.add('active');
        }

        // ÂÖ≥Èó≠ÂØºÂÖ•Ê®°ÊÄÅÊ°Ü
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        // ÂØºÂÖ•‰π¶Á≠æ
        document.getElementById('importForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const fileInput = document.getElementById('bookmarkFile');
            const checkDuplicates = document.getElementById('checkDuplicates').checked;
            const importBtn = document.getElementById('importBtn');
            const progressDiv = document.getElementById('importProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            if (!fileInput.files || !fileInput.files[0]) {
                showAlert('ËØ∑ÈÄâÊã©Êñá‰ª∂', 'error');
                return;
            }

            const file = fileInput.files[0];

            // È™åËØÅÊñá‰ª∂Á±ªÂûã
            if (!file.name.toLowerCase().endsWith('.html') && !file.name.toLowerCase().endsWith('.htm')) {
                showAlert('ËØ∑ÈÄâÊã©HTMLÊ†ºÂºèÁöÑ‰π¶Á≠æÊñá‰ª∂', 'error');
                return;
            }

            // ÊòæÁ§∫ËøõÂ∫¶Êù°
            progressDiv.style.display = 'block';
            progressBar.style.width = '30%';
            progressText.textContent = 'Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂...';
            importBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('bookmarkFile', file);
                formData.append('checkDuplicates', checkDuplicates);

                progressBar.style.width = '50%';
                progressText.textContent = 'Ê≠£Âú®Ëß£Êûê‰π¶Á≠æ...';

                const response = await fetch(`${window.location.origin}/daohang/api/import_bookmarks.php`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                    },
                    body: formData
                });

                const data = await response.json();

                progressBar.style.width = '100%';

                if (data.success) {
                    progressText.textContent = `ÂØºÂÖ•ÊàêÂäüÔºÅÂÖ± ${data.data.total} Êù°ÔºåÊàêÂäü ${data.data.imported} Êù°ÔºåË∑≥Ëøá ${data.data.skipped} Êù°`;

                    if (data.data.errors && data.data.errors.length > 0) {
                        console.warn('ÂØºÂÖ•Ë≠¶Âëä:', data.data.errors);
                    }

                    showAlert(data.message, 'success');

                    // Âª∂ËøüÂÖ≥Èó≠Âπ∂Âà∑Êñ∞ÂàóË°®
                    setTimeout(() => {
                        closeImportModal();
                        loadSites();
                    }, 2000);
                } else {
                    progressText.textContent = 'ÂØºÂÖ•Â§±Ë¥•';
                    console.error('Import error:', data);
                    const errorMsg = data.message || 'ÂØºÂÖ•Â§±Ë¥•ÔºåËØ∑ÈáçËØï';
                    if (data.error_detail) {
                        console.error('Error detail:', data.error_detail);
                    }
                    showAlert(errorMsg, 'error');
                }
            } catch (error) {
                console.error('ÂØºÂÖ•Â§±Ë¥•:', error);
                progressText.textContent = 'ÂØºÂÖ•Â§±Ë¥•';
                showAlert('ÂØºÂÖ•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂Ê†ºÂºèÊàñÁΩëÁªúËøûÊé•', 'error');
            } finally {
                importBtn.disabled = false;
            }
        });

        // Âä†ËΩΩÁΩëÁ´ôÂàóË°®
        async function loadSites() {
            try {
                const response = await fetch(`${window.location.origin}/daohang/api/sites.php`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                    }
                });

                if (!response.ok) {
                    throw new Error('Âä†ËΩΩÂ§±Ë¥•');
                }

                const data = await response.json();
                renderSites(data.sites || []);
                updateStats(data.sites || []);
            } catch (error) {
                console.error('Âä†ËΩΩÁΩëÁ´ôÂàóË°®Â§±Ë¥•:', error);
                document.getElementById('sitesTable').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                            Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï
                        </td>
                    </tr>
                `;
            }
        }

        // Ê∏≤ÊüìÁΩëÁ´ôÂàóË°®ÔºàÊåâÂàÜÁ±ªÂàÜÁªÑÔºâ
        function renderSites(sites) {
            const tbody = document.getElementById('sitesTable');
            
            // Êõ¥Êñ∞ÊÄªËÆ∞ÂΩïÊï∞
            document.getElementById('totalCount').textContent = sites.length;
            
            if (sites.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                            ÊöÇÊó†ÁΩëÁ´ôÊï∞ÊçÆÔºåÁÇπÂáªÂè≥‰∏äËßíÊ∑ªÂä†ÁΩëÁ´ô
                        </td>
                    </tr>
                `;
                return;
            }

            // ÊåâÂàÜÁ±ªÂàÜÁªÑ
            const groupedSites = {};
            sites.forEach(site => {
                const category = site.category || 'Êú™ÂàÜÁ±ª';
                if (!groupedSites[category]) {
                    groupedSites[category] = [];
                }
                groupedSites[category].push(site);
            });

            // ÂÆö‰πâÂàÜÁ±ªÈ°∫Â∫èÂíåÂõæÊ†á
            const categoryOrder = [
                { name: 'Âú®Á∫øÂ∑•ÂÖ∑', icon: 'üìö' },
                { name: 'ÂÆâÂÖ®Â∑•ÂÖ∑', icon: 'üõ°Ô∏è' },
                { name: 'ÂºÄÂèëËøêÁª¥', icon: 'üíª' },
                { name: 'ÁΩëÁªúÂüüÂêç', icon: 'üåê' },
                { name: 'ÊäÄÊúØÊïôÁ®ã', icon: 'üìö' },
                { name: 'AIÂ∑•ÂÖ∑', icon: 'ü§ñ' },
                { name: 'Êú™ÂàÜÁ±ª', icon: 'üìÇ' }
            ];

            let html = '';
            categoryOrder.forEach(cat => {
                const categorySites = groupedSites[cat.name];
                if (!categorySites || categorySites.length === 0) return;

                // Ê∑ªÂä†ÂàÜÁ±ªÊ†áÈ¢òË°å
                html += `
                    <tr style="background: #007bff; cursor: pointer;"
                        onclick="toggleCategory('${cat.name}')">
                        <td colspan="5" style="padding: 15px 20px; color: white; font-weight: 600; font-size: 1.05em;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.2em;">${cat.icon}</span>
                                <span>${cat.name}</span>
                                <span style="background: rgba(255,255,255,0.3); padding: 3px 10px; border-radius: 12px; font-size: 0.85em;">
                                    ${categorySites.length} ‰∏™ÁΩëÁ´ô
                                </span>
                                <span id="toggle-${cat.name}" style="margin-left: auto; font-size: 0.9em;">‚ñº</span>
                            </div>
                        </td>
                    </tr>
                `;

                // Ê∑ªÂä†ËØ•ÂàÜÁ±ª‰∏ãÁöÑÊâÄÊúâÁΩëÁ´ô
                categorySites.forEach(site => {
                    const isIconUrl = site.icon && (site.icon.startsWith('http') || site.icon.startsWith('//'));
                    const iconHtml = isIconUrl
                        ? `<img src="${site.icon}" style="width: 32px; height: 32px; border-radius: 6px;" onerror="this.style.display='none';this.parentElement.innerHTML='üåê';">`
                        : (site.icon || 'üåê');
                    
                    html += `
                    <tr class="category-${cat.name}" data-category="${cat.name}">
                        <td>
                            <div class="site-info">
                                <div class="site-icon">${iconHtml}</div>
                                <div class="site-details">
                                    <h4>${site.name}</h4>
                                    <p>${new URL(site.url).hostname}</p>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="category-tag">${site.category}</span>
                        </td>
                        <td>
                            <a href="${site.url}" target="_blank" style="color: #007bff; text-decoration: none;">
                                ËÆøÈóÆ
                            </a>
                        </td>
                        <td style="max-width: 300px;">
                            ${site.description}
                        </td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-primary btn-sm" onclick='editSite(${JSON.stringify(site).replace(/'/g, "&apos;")})'>
                                    ÁºñËæë
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteSite(${site.id})">
                                    Âà†Èô§
                                </button>
                            </div>
                        </td>
                    </tr>`;
                });
            });

            tbody.innerHTML = html;
        }

        // ÂàáÊç¢ÂàÜÁ±ªÂ±ïÂºÄ/Êî∂Ëµ∑
        function toggleCategory(categoryName) {
            const rows = document.querySelectorAll(`.category-${categoryName}`);
            const toggle = document.getElementById(`toggle-${categoryName}`);
            
            rows.forEach(row => {
                if (row.style.display === 'none') {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            if (toggle) {
                toggle.textContent = toggle.textContent === '‚ñº' ? '‚ñ∂' : '‚ñº';
            }
        }

        // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
        async function updateStats(sites) {
            document.getElementById('totalSites').textContent = sites.length;
            const categories = new Set(sites.map(s => s.category));
            document.getElementById('totalCategories').textContent = categories.size;
            
            // Ëé∑ÂèñÁúüÂÆûËÆøÈóÆÁªüËÆ°
            try {
                const response = await fetch(`${window.location.origin}/daohang/api/visitor.php`);
                const data = await response.json();
                if (data.success) {
                    document.getElementById('todayVisits').textContent = data.today_visits || 0;
                }
            } catch (error) {
                console.error('Ëé∑ÂèñËÆøÈóÆÁªüËÆ°Â§±Ë¥•:', error);
                document.getElementById('todayVisits').textContent = 0;
            }
        }

        // ÁºñËæëÁΩëÁ´ô
        function editSite(site) {
            openEditModal(site);
        }

        // Âà†Èô§ÁΩëÁ´ô
        async function deleteSite(id) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÁΩëÁ´ôÂêó?')) {
                return;
            }

            try {
                const response = await fetch(`${window.location.origin}/daohang/api/sites.php?id=${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Âà†Èô§ÊàêÂäü', 'success');
                    loadSites();
                } else {
                    showAlert(data.message || 'Âà†Èô§Â§±Ë¥•', 'error');
                }
            } catch (error) {
                showAlert('Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
                console.error('Âà†Èô§Â§±Ë¥•:', error);
            }
        }

        // ‰øùÂ≠òÁΩëÁ´ô
        document.getElementById('siteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const siteData = Object.fromEntries(formData.entries());
            
            // È™åËØÅURLÊ†ºÂºè
            const url = siteData.url ? siteData.url.trim() : '';
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showAlert('ÁΩëÂùÄÂøÖÈ°ª‰ª• http:// Êàñ https:// ÂºÄÂ§¥', 'error');
                return;
            }
            siteData.url = url;
            
            // Ê£ÄÊü•ÂõæÊ†áÊòØÂê¶‰∏∫URLÔºåÂ¶ÇÊûúÊòØÂàô‰øùÁïôÔºåÂê¶ÂàôÁ°Æ‰øùÊúâÂÄº
            const iconValue = siteData.icon ? siteData.icon.trim() : '';
            if (!iconValue) {
                siteData.icon = 'üåê';
            }

            try {
                const url = siteData.id ? `${window.location.origin}/daohang/api/sites.php?id=${siteData.id}` : `${window.location.origin}/daohang/api/sites.php`;
                const method = siteData.id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                    },
                    body: JSON.stringify(siteData)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(siteData.id ? 'Êõ¥Êñ∞ÊàêÂäü' : 'Ê∑ªÂä†ÊàêÂäü', 'success');
                    closeModal();
                    loadSites();
                } else {
                    showAlert(data.message || 'Êìç‰ΩúÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                showAlert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message, 'error');
                console.error('‰øùÂ≠òÂ§±Ë¥•:', error);
            }
        });

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        document.getElementById('siteModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeModal();
            }
        });

        document.getElementById('importModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeImportModal();
            }
        });

        // Ëé∑ÂèñÁΩëÁ´ôÂÖÉÊï∞ÊçÆ
        let isFetchingMetadata = false;
        
        // URLÈ™åËØÅÂíåËé∑ÂèñÂÖÉÊï∞ÊçÆ
        async function validateAndFetchMetadata() {
            const urlInput = document.getElementById('siteUrl');
            const url = urlInput.value.trim();
            
            // È™åËØÅURLÊ†ºÂºè
            if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
                showAlert('ÁΩëÂùÄÂøÖÈ°ª‰ª• http:// Êàñ https:// ÂºÄÂ§¥', 'error');
                return;
            }
            
            await fetchMetadata();
        }
        
        async function fetchMetadata() {
            const urlInput = document.getElementById('siteUrl');
            const url = urlInput.value.trim();
            
            // Â¶ÇÊûúÊ≠£Âú®Ëé∑ÂèñÊàñURL‰∏∫Á©∫ÊàñÂú®ÁºñËæëÊ®°ÂºèÔºåÂàô‰∏çËá™Âä®Ëé∑Âèñ
            if (isFetchingMetadata || !url || document.getElementById('siteId').value) {
                return;
            }
            
            // È™åËØÅURLÊ†ºÂºè
            try {
                new URL(url);
            } catch {
                return;
            }
            
            isFetchingMetadata = true;
            const nameInput = document.getElementById('siteName');
            const iconInput = document.getElementById('siteIcon');
            const descInput = document.getElementById('siteDescription');
            const iconPreview = document.getElementById('iconPreview');
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const originalPlaceholder = nameInput.placeholder;
            nameInput.placeholder = 'Ê≠£Âú®Ëé∑ÂèñÁΩëÁ´ô‰ø°ÊÅØ...';
            nameInput.disabled = true;
            
            try {
                const response = await fetch(`${window.location.origin}/daohang/api/fetch_metadata.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                    },
                    body: JSON.stringify({ url: url })
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    // Ëá™Âä®Â°´ÂÖÖÊ†áÈ¢ò
                    if (data.data.title && !nameInput.value) {
                        nameInput.value = data.data.title;
                    }
                    
                    // Â§ÑÁêÜÂõæÊ†á
                    if (data.data.icon) {
                        // ÊòæÁ§∫ÂõæÊ†áÈ¢ÑËßà
                        iconPreview.src = data.data.icon;
                        iconPreview.style.display = 'block';
                        iconPreview.onerror = function() {
                            this.style.display = 'none';
                            if (!iconInput.value) {
                                iconInput.value = 'üåê';
                            }
                        };
                        
                        // Â∞ÜÂõæÊ†áURLÂ≠òÂÇ®Âà∞hidden inputÊàñÁõ¥Êé•‰ΩøÁî®
                        if (!iconInput.value) {
                            iconInput.value = data.data.icon;
                        }
                    } else {
                        iconPreview.style.display = 'none';
                        if (!iconInput.value) {
                            iconInput.value = 'üåê';
                        }
                    }
                    
                    // Ëá™Âä®Â°´ÂÖÖÊèèËø∞
                    if (data.data.description && !descInput.value) {
                        descInput.value = data.data.description;
                    }
                    
                    showAlert('Â∑≤Ëá™Âä®Ëé∑ÂèñÁΩëÁ´ô‰ø°ÊÅØ', 'success');
                } else {
                    // Ëé∑ÂèñÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÂõæÊ†á
                    if (!iconInput.value) {
                        iconInput.value = 'üåê';
                    }
                    iconPreview.style.display = 'none';
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÂÖÉÊï∞ÊçÆÂ§±Ë¥•:', error);
                if (!iconInput.value) {
                    iconInput.value = 'üåê';
                }
                iconPreview.style.display = 'none';
            } finally {
                nameInput.placeholder = originalPlaceholder;
                nameInput.disabled = false;
                isFetchingMetadata = false;
            }
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•ËÆ§ËØÅÂπ∂Âä†ËΩΩÊï∞ÊçÆ
        if (checkAuth()) {
            loadSites();
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç† - å¯¼èˆªç«™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #ffffff;
            min-height: 100vh;
        }

        .header {
            background: #ffffff;
            color: #333;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .header h1 {
            font-size: 1.5em;
            color: #333;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            font-weight: 600;
            border: 2px solid #007bff;
        }

        .btn-primary:hover {
            background: #0056b3;
            border-color: #0056b3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #007bff;
            color: white;
            font-weight: 600;
        }

        .btn-success:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            font-weight: 600;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: transparent;
            color: #333;
        }

        .stat-info h3 {
            font-size: 2em;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-info p {
            color: #666;
            font-size: 0.9em;
        }

        .content-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section-header {
            padding: 20px 25px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 1.3em;
            color: #333;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f9fafb;
        }

        th {
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            color: #666;
            font-size: 0.9em;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
        }

        tbody tr {
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        .site-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .site-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: transparent;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .site-details h4 {
            font-size: 0.95em;
            color: #333;
            margin-bottom: 3px;
        }

        .site-details p {
            font-size: 0.85em;
            color: #999;
        }

        .category-tag {
            display: inline-block;
            padding: 5px 12px;
            background: #e0e7ff;
            color: #007bff;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 0.85em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            margin-bottom: 25px;
        }

        .modal-header h3 {
            font-size: 1.5em;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.3s ease;
            outline: none;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
            display: none;
        }

        .alert-error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .alert-success {
            background: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }

        @media (max-width: 768px) {
            .stats {
                grid-template-columns: 1fr;
            }

            .table-container {
                font-size: 0.9em;
            }

            th, td {
                padding: 12px 15px;
            }

            .actions {
                flex-direction: column;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š å¯¼èˆªç«™åå°ç®¡ç†</h1>
        <div class="header-actions">
            <a href="/daohang/index.html" class="btn btn-primary">æŸ¥çœ‹å‰å°</a>
            <button class="btn btn-danger" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <div class="container">
        <div id="alert" class="alert"></div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“š</div>
                <div class="stat-info">
                    <h3 id="totalSites">0</h3>
                    <p>ç½‘ç«™æ€»æ•°</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“‚</div>
                <div class="stat-info">
                    <h3 id="totalCategories">0</h3>
                    <p>åˆ†ç±»æ•°é‡</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘€</div>
                <div class="stat-info">
                    <h3 id="todayVisits">0</h3>
                    <p>ä»Šæ—¥è®¿é—®</p>
                </div>
            </div>
        </div>

        <div class="content-section">
            <div class="section-header">
                <h2>ç½‘ç«™ç®¡ç†</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="openImportModal()">ğŸ“¥ å¯¼å…¥ä¹¦ç­¾</button>
                    <button class="btn btn-success" onclick="openAddModal()">+ æ·»åŠ ç½‘ç«™</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ç½‘ç«™ä¿¡æ¯</th>
                            <th>åˆ†ç±»</th>
                            <th>ç½‘å€</th>
                            <th>æè¿°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="sitesTable">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px;">
                                åŠ è½½ä¸­...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="paginationContainer" style="padding: 20px; display: flex; justify-content: space-between; align-items: center; border-top: 2px solid #f0f0f0;">
                <div style="color: #666; font-size: 0.9em;">
                    å…± <strong id="totalCount" style="color: #007bff;">0</strong> æ¡è®°å½•
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ç½‘ç«™æ¨¡æ€æ¡† -->
    <div id="siteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">æ·»åŠ ç½‘ç«™</h3>
            </div>
            <form id="siteForm">
                <input type="hidden" id="siteId" name="id">

                <div class="form-group">
                    <label for="siteName">ç½‘ç«™åç§° *</label>
                    <input type="text" id="siteName" name="name" required>
                </div>

                <div class="form-group">
                    <label for="siteUrl">ç½‘ç«™ç½‘å€ *</label>
                    <input type="text" id="siteUrl" name="url" required placeholder="https://example.com" onblur="validateAndFetchMetadata()">
                    <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;">è¾“å…¥ç½‘å€åè‡ªåŠ¨è·å–æ ‡é¢˜å’Œå›¾æ ‡(å¿…é¡»ä»¥http://æˆ–https://å¼€å¤´)</small>
                </div>

                <div class="form-group">
                    <label for="siteIcon">ç½‘ç«™å›¾æ ‡</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="siteIcon" name="icon" placeholder="ğŸŒ" style="flex: 1;">
                        <img id="iconPreview" src="" style="width: 40px; height: 40px; border-radius: 8px; display: none; border: 2px solid #e0e0e0;">
                    </div>
                    <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;">å¯ä»¥è¾“å…¥emojiæˆ–è‡ªåŠ¨è·å–ç½‘ç«™å›¾æ ‡</small>
                </div>

                <div class="form-group">
                    <label for="siteCategory">åˆ†ç±» *</label>
                    <select id="siteCategory" name="category" required>
                        <option value="">é€‰æ‹©åˆ†ç±»</option>
                        <option value="åœ¨çº¿å·¥å…·">ğŸ“š åœ¨çº¿å·¥å…· & å®ç”¨æŸ¥è¯¢</option>
                        <option value="å®‰å…¨å·¥å…·">ğŸ›¡ï¸ å®‰å…¨å·¥å…· & æµ‹ç»˜å¹³å°</option>
                        <option value="å¼€å‘è¿ç»´">ğŸ’» å¼€å‘è¿ç»´ & ä¸»æœºæœåŠ¡</option>
                        <option value="ç½‘ç»œåŸŸå">ğŸŒ ç½‘ç»œ & åŸŸåå·¥å…·</option>
                        <option value="æŠ€æœ¯æ•™ç¨‹">ğŸ“š æŠ€æœ¯æ•™ç¨‹ & ç¤¾åŒº</option>
                        <option value="AIå·¥å…·">ğŸ¤– AIå·¥å…· & å…¶ä»–</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="siteDescription">ç½‘ç«™æè¿° *</label>
                    <textarea id="siteDescription" name="description" required></textarea>
                </div>

                <div class="form-group">
                    <label for="siteKeywords">å…³é”®è¯ (ç”¨ç©ºæ ¼åˆ†éš”)</label>
                    <input type="text" id="siteKeywords" name="keywords" placeholder="å·¥å…· åœ¨çº¿ æŸ¥è¯¢">
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å¯¼å…¥ä¹¦ç­¾æ¨¡æ€æ¡† -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“¥ å¯¼å…¥ä¹¦ç­¾æ–‡ä»¶</h3>
            </div>
            <form id="importForm">
                <div class="form-group">
                    <label for="bookmarkFile">é€‰æ‹©ä¹¦ç­¾æ–‡ä»¶ *</label>
                    <input type="file" id="bookmarkFile" name="bookmarkFile" accept=".html,.htm" required style="padding: 10px;">
                    <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;">
                        æ”¯æŒ Netscape ä¹¦ç­¾æ ¼å¼ (Chromeã€Firefoxã€Edge å¯¼å‡ºçš„ä¹¦ç­¾æ–‡ä»¶)
                    </small>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="checkDuplicates" name="checkDuplicates" checked style="width: auto; cursor: pointer;">
                        <span>è·³è¿‡é‡å¤çš„ç½‘å€</span>
                    </label>
                    <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;">
                        å‹¾é€‰åå°†è‡ªåŠ¨è·³è¿‡æ•°æ®åº“ä¸­å·²å­˜åœ¨çš„ç½‘å€
                    </small>
                </div>

                <div id="importProgress" style="display: none; margin: 20px 0;">
                    <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div id="progressBar" style="background: #007bff; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <p id="progressText" style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9em;"></p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeImportModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success" id="importBtn">å¼€å§‹å¯¼å…¥</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuth() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                window.location.href = '/daohang/admin/login.html';
                return false;
            }
            return true;
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—?')) {
                localStorage.removeItem('admin_token');
                window.location.href = '/daohang/admin/login.html';
            }
        }

        // æ˜¾ç¤ºæç¤º
        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        // æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ ç½‘ç«™';
            document.getElementById('siteForm').reset();
            document.getElementById('siteId').value = '';
            document.getElementById('siteModal').classList.add('active');
        }

        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        function openEditModal(site) {
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ç½‘ç«™';
            document.getElementById('siteId').value = site.id;
            document.getElementById('siteName').value = site.name;
            document.getElementById('siteUrl').value = site.url;
            document.getElementById('siteIcon').value = site.icon || '';
            document.getElementById('siteCategory').value = site.category;
            document.getElementById('siteDescription').value = site.description;
            document.getElementById('siteKeywords').value = site.keywords || '';
            document.getElementById('siteModal').classList.add('active');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('siteModal').classList.remove('active');
        }

        // æ‰“å¼€å¯¼å…¥æ¨¡æ€æ¡†
        function openImportModal() {
            document.getElementById('importForm').reset();
            document.getElementById('importProgress').style.display = 'none';
            document.getElementById('importModal').classList.add('active');
        }

        // å…³é—­å¯¼å…¥æ¨¡æ€æ¡†
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        // å¯¼å…¥ä¹¦ç­¾
        document.getElementById('importForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const fileInput = document.getElementById('bookmarkFile');
            const checkDuplicates = document.getElementById('checkDuplicates').checked;
            const importBtn = document.getElementById('importBtn');
            const progressDiv = document.getElementById('importProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            if (!fileInput.files || !fileInput.files[0]) {
                showAlert('è¯·é€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            const file = fileInput.files[0];

            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.name.toLowerCase().endsWith('.html') && !file.name.toLowerCase().endsWith('.htm')) {
                showAlert('è¯·é€‰æ‹©HTMLæ ¼å¼çš„ä¹¦ç­¾æ–‡ä»¶', 'error');
                return;
            }

            // æ˜¾ç¤ºè¿›åº¦æ¡
            progressDiv.style.display = 'block';
            progressBar.style.width = '30%';
            progressText.textContent = 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...';
            importBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('bookmarkFile', file);
                formData.append('checkDuplicates', checkDuplicates);

                progressBar.style.width = '50%';
                progressText.textContent = 'æ­£åœ¨è§£æä¹¦ç­¾...';

                const response = await fetch(`${window.location.origin}/daohang/api/import_bookmarks.php`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                    },
                    body: formData
                });

                const data = await response.json();

                progressBar.style.width = '100%';

                if (data.success) {
                    progressText.textContent = `å¯¼å…¥æˆåŠŸï¼å…± ${data.data.total} æ¡ï¼ŒæˆåŠŸ ${data.data.imported} æ¡ï¼Œè·³è¿‡ ${data.data.skipped} æ¡`;

                    if (data.data.errors && data.data.errors.length > 0) {
                        console.warn('å¯¼å…¥è­¦å‘Š:', data.data.errors);
                    }

                    showAlert(data.message, 'success');

                    // å»¶è¿Ÿå…³é—­å¹¶åˆ·æ–°åˆ—è¡¨
                    setTimeout(() => {
                        closeImportModal();
                        loadSites();
                    }, 2000);
                } else {
                    progressText.textContent = 'å¯¼å…¥å¤±è´¥';
                    console.error('Import error:', data);
                    const errorMsg = data.message || 'å¯¼å…¥å¤±è´¥ï¼Œè¯·é‡è¯•';
                    if (data.error_detail) {
                        console.error('Error detail:', data.error_detail);
                    }
                    showAlert(errorMsg, 'error');
                }
            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                progressText.textContent = 'å¯¼å…¥å¤±è´¥';
                showAlert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–ç½‘ç»œè¿æ¥', 'error');
            } finally {
                importBtn.disabled = false;
            }
        });

        // åŠ è½½ç½‘ç«™åˆ—è¡¨
        async function loadSites() {
            try {
                const response = await fetch(`${window.location.origin}/daohang/api/sites.php`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                    }
                });

                if (!response.ok) {
                    throw new Error('åŠ è½½å¤±è´¥');
                }

                const data = await response.json();
                renderSites(data.sites || []);
                updateStats(data.sites || []);
            } catch (error) {
                console.error('åŠ è½½ç½‘ç«™åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('sitesTable').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                            åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•
                        </td>
                    </tr>
                `;
            }
        }

        // æ¸²æŸ“ç½‘ç«™åˆ—è¡¨ï¼ˆæŒ‰åˆ†ç±»åˆ†ç»„ï¼‰
        function renderSites(sites) {
            const tbody = document.getElementById('sitesTable');
            
            // æ›´æ–°æ€»è®°å½•æ•°
            document.getElementById('totalCount').textContent = sites.length;
            
            if (sites.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                            æš‚æ— ç½‘ç«™æ•°æ®ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ ç½‘ç«™
                        </td>
                    </tr>
                `;
                return;
            }

            // æŒ‰åˆ†ç±»åˆ†ç»„
            const groupedSites = {};
            sites.forEach(site => {
                const category = site.category || 'æœªåˆ†ç±»';
                if (!groupedSites[category]) {
                    groupedSites[category] = [];
                }
                groupedSites[category].push(site);
            });

            // å®šä¹‰åˆ†ç±»é¡ºåºå’Œå›¾æ ‡
            const categoryOrder = [
                { name: 'åœ¨çº¿å·¥å…·', icon: 'ğŸ“š' },
                { name: 'å®‰å…¨å·¥å…·', icon: 'ğŸ›¡ï¸' },
                { name: 'å¼€å‘è¿ç»´', icon: 'ğŸ’»' },
                { name: 'ç½‘ç»œåŸŸå', icon: 'ğŸŒ' },
                { name: 'æŠ€æœ¯æ•™ç¨‹', icon: 'ğŸ“š' },
                { name: 'AIå·¥å…·', icon: 'ğŸ¤–' },
                { name: 'æœªåˆ†ç±»', icon: 'ğŸ“‚' }
            ];

            let html = '';
            categoryOrder.forEach(cat => {
                const categorySites = groupedSites[cat.name];
                if (!categorySites || categorySites.length === 0) return;

                // æ·»åŠ åˆ†ç±»æ ‡é¢˜è¡Œ
                html += `
                    <tr style="background: #007bff; cursor: pointer;"
                        onclick="toggleCategory('${cat.name}')">
                        <td colspan="5" style="padding: 15px 20px; color: white; font-weight: 600; font-size: 1.05em;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.2em;">${cat.icon}</span>
                                <span>${cat.name}</span>
                                <span style="background: rgba(255,255,255,0.3); padding: 3px 10px; border-radius: 12px; font-size: 0.85em;">
                                    ${categorySites.length} ä¸ªç½‘ç«™
                                </span>
                                <span id="toggle-${cat.name}" style="margin-left: auto; font-size: 0.9em;">â–¼</span>
                            </div>
                        </td>
                    </tr>
                `;

                // æ·»åŠ è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰ç½‘ç«™
                categorySites.forEach(site => {
                    const isIconUrl = site.icon && (site.icon.startsWith('http') || site.icon.startsWith('//'));
                    const iconHtml = isIconUrl
                        ? `<img src="${site.icon}" style="width: 32px; height: 32px; border-radius: 6px;" onerror="this.style.display='none';this.parentElement.innerHTML='ğŸŒ';">`
                        : (site.icon || 'ğŸŒ');
                    
                    html += `
                    <tr class="category-${cat.name}" data-category="${cat.name}">
                        <td>
                            <div class="site-info">
                                <div class="site-icon">${iconHtml}</div>
                                <div class="site-details">
                                    <h4>${site.name}</h4>
                                    <p>${new URL(site.url).hostname}</p>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="category-tag">${site.category}</span>
                        </td>
                        <td>
                            <a href="${site.url}" target="_blank" style="color: #007bff; text-decoration: none;">
                                è®¿é—®
                            </a>
                        </td>
                        <td style="max-width: 300px;">
                            ${site.description}
                        </td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-primary btn-sm" onclick='editSite(${JSON.stringify(site).replace(/'/g, "&apos;")})'>
                                    ç¼–è¾‘
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteSite(${site.id})">
                                    åˆ é™¤
                                </button>
                            </div>
                        </td>
                    </tr>`;
                });
            });

            tbody.innerHTML = html;
        }

        // åˆ‡æ¢åˆ†ç±»å±•å¼€/æ”¶èµ·
        function toggleCategory(categoryName) {
            const rows = document.querySelectorAll(`.category-${categoryName}`);
            const toggle = document.getElementById(`toggle-${categoryName}`);
            
            rows.forEach(row => {
                if (row.style.display === 'none') {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            if (toggle) {
                toggle.textContent = toggle.textContent === 'â–¼' ? 'â–¶' : 'â–¼';
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        async function updateStats(sites) {
            document.getElementById('totalSites').textContent = sites.length;
            const categories = new Set(sites.map(s => s.category));
            document.getElementById('totalCategories').textContent = categories.size;
            
            // è·å–çœŸå®è®¿é—®ç»Ÿè®¡
            try {
                const response = await fetch(`${window.location.origin}/daohang/api/visitor.php`);
                const data = await response.json();
                if (data.success) {
                    document.getElementById('todayVisits').textContent = data.today_visits || 0;
                }
            } catch (error) {
                console.error('è·å–è®¿é—®ç»Ÿè®¡å¤±è´¥:', error);
                document.getElementById('todayVisits').textContent = 0;
            }
        }

        // ç¼–è¾‘ç½‘ç«™
        function editSite(site) {
            openEditModal(site);
        }

        // åˆ é™¤ç½‘ç«™
        async function deleteSite(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç½‘ç«™å—?')) {
                return;
            }

            try {
                const response = await fetch(`${window.location.origin}/daohang/api/sites.php?id=${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('åˆ é™¤æˆåŠŸ', 'success');
                    loadSites();
                } else {
                    showAlert(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                console.error('åˆ é™¤å¤±è´¥:', error);
            }
        }

        // ä¿å­˜ç½‘ç«™
        document.getElementById('siteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const siteData = Object.fromEntries(formData.entries());
            
            // éªŒè¯URLæ ¼å¼
            const url = siteData.url ? siteData.url.trim() : '';
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showAlert('ç½‘å€å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´', 'error');
                return;
            }
            siteData.url = url;
            
            // æ£€æŸ¥å›¾æ ‡æ˜¯å¦ä¸ºURLï¼Œå¦‚æœæ˜¯åˆ™ä¿ç•™ï¼Œå¦åˆ™ç¡®ä¿æœ‰å€¼
            const iconValue = siteData.icon ? siteData.icon.trim() : '';
            if (!iconValue) {
                siteData.icon = 'ğŸŒ';
            }

            try {
                const url = siteData.id ? `${window.location.origin}/daohang/api/sites.php?id=${siteData.id}` : `${window.location.origin}/daohang/api/sites.php`;
                const method = siteData.id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                    },
                    body: JSON.stringify(siteData)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(siteData.id ? 'æ›´æ–°æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ', 'success');
                    closeModal();
                    loadSites();
                } else {
                    showAlert(data.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('æ“ä½œå¤±è´¥: ' + error.message, 'error');
                console.error('ä¿å­˜å¤±è´¥:', error);
            }
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('siteModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeModal();
            }
        });

        document.getElementById('importModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeImportModal();
            }
        });

        // è·å–ç½‘ç«™å…ƒæ•°æ®
        let isFetchingMetadata = false;
        
        // URLéªŒè¯å’Œè·å–å…ƒæ•°æ®
        async function validateAndFetchMetadata() {
            const urlInput = document.getElementById('siteUrl');
            const url = urlInput.value.trim();
            
            // éªŒè¯URLæ ¼å¼
            if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
                showAlert('ç½‘å€å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´', 'error');
                return;
            }
            
            await fetchMetadata();
        }
        
        async function fetchMetadata() {
            const urlInput = document.getElementById('siteUrl');
            const url = urlInput.value.trim();
            
            // å¦‚æœæ­£åœ¨è·å–æˆ–URLä¸ºç©ºæˆ–åœ¨ç¼–è¾‘æ¨¡å¼ï¼Œåˆ™ä¸è‡ªåŠ¨è·å–
            if (isFetchingMetadata || !url || document.getElementById('siteId').value) {
                return;
            }
            
            // éªŒè¯URLæ ¼å¼
            try {
                new URL(url);
            } catch {
                return;
            }
            
            isFetchingMetadata = true;
            const nameInput = document.getElementById('siteName');
            const iconInput = document.getElementById('siteIcon');
            const descInput = document.getElementById('siteDescription');
            const iconPreview = document.getElementById('iconPreview');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const originalPlaceholder = nameInput.placeholder;
            nameInput.placeholder = 'æ­£åœ¨è·å–ç½‘ç«™ä¿¡æ¯...';
            nameInput.disabled = true;
            
            try {
                const response = await fetch(`${window.location.origin}/daohang/api/fetch_metadata.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                    },
                    body: JSON.stringify({ url: url })
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    // è‡ªåŠ¨å¡«å……æ ‡é¢˜
                    if (data.data.title && !nameInput.value) {
                        nameInput.value = data.data.title;
                    }
                    
                    // å¤„ç†å›¾æ ‡
                    if (data.data.icon) {
                        // æ˜¾ç¤ºå›¾æ ‡é¢„è§ˆ
                        iconPreview.src = data.data.icon;
                        iconPreview.style.display = 'block';
                        iconPreview.onerror = function() {
                            this.style.display = 'none';
                            if (!iconInput.value) {
                                iconInput.value = 'ğŸŒ';
                            }
                        };
                        
                        // å°†å›¾æ ‡URLå­˜å‚¨åˆ°hidden inputæˆ–ç›´æ¥ä½¿ç”¨
                        if (!iconInput.value) {
                            iconInput.value = data.data.icon;
                        }
                    } else {
                        iconPreview.style.display = 'none';
                        if (!iconInput.value) {
                            iconInput.value = 'ğŸŒ';
                        }
                    }
                    
                    // è‡ªåŠ¨å¡«å……æè¿°
                    if (data.data.description && !descInput.value) {
                        descInput.value = data.data.description;
                    }
                    
                    showAlert('å·²è‡ªåŠ¨è·å–ç½‘ç«™ä¿¡æ¯', 'success');
                } else {
                    // è·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡
                    if (!iconInput.value) {
                        iconInput.value = 'ğŸŒ';
                    }
                    iconPreview.style.display = 'none';
                }
            } catch (error) {
                console.error('è·å–å…ƒæ•°æ®å¤±è´¥:', error);
                if (!iconInput.value) {
                    iconInput.value = 'ğŸŒ';
                }
                iconPreview.style.display = 'none';
            } finally {
                nameInput.placeholder = originalPlaceholder;
                nameInput.disabled = false;
                isFetchingMetadata = false;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯å¹¶åŠ è½½æ•°æ®
        if (checkAuth()) {
            loadSites();
        }
    </script>
</body>
</html>